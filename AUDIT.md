# Аудит Cladhunter (MongoDB + TON)

## Краткое резюме
- REST API вынесен в отдельный бэкенд (`backend/src/routes.ts`) и обслуживается поверх Node HTTP сервера.【F:backend/src/routes.ts†L1-L166】【F:backend/src/server.ts†L1-L28】
- Авторизация по-прежнему привязана к данным клиента (TON Connect) и не проверяется сервером, поэтому злоумышленник может подделывать `userId` и выполнять любые операции.【F:backend/src/routes.ts†L63-L152】【F:backend/src/services/userService.ts†L97-L266】
- Бизнес-проверки (лимиты рекламы, партнёрские награды, подтверждение платежей) реализованы через Mongoose без внешних вебхуков и полагаются на корректность клиента.【F:backend/src/services/userService.ts†L167-L356】

## Критические находки

### 1. Нет серверной аутентификации запросов
**Риск.** API опирается на `userId`, полученный из запроса. Любой может создать произвольный идентификатор и «майнить» энергию, активировать бусты или забирать партнёрские награды без ограничений.【F:backend/src/routes.ts†L63-L152】【F:backend/src/services/userService.ts†L97-L221】

**Рекомендации.**
- Внедрить подпись запросов (например, JWT, выданный сервером после проверки TON Connect).
- Вести историю сессий и блокировать подозрительные запросы (rate limiting + IP/UA анализ).

### 2. Подтверждение платежей не требует реальной транзакции
**Риск.** Эндпоинты `/api/orders/confirm` и `/api/orders/register-payment` сразу переводят заказ в статус `paid`/`pending_verification`, увеличивая уровень буста без проверки факта оплаты.【F:backend/src/services/userService.ts†L188-L277】

**Рекомендации.**
- Добавить вебхук TON и подтверждать статус заказа только после проверки транзакции.
- Хранить и сверять сумму/кошелёк при подтверждении, запрещать повторное использование payload.

### 3. Клиент контролирует награды и просмотры
**Риск.** Фронтенд свободно вызывает `/api/ads/complete` и `/api/rewards/claim`. Валидация ограничивается лимитами по количеству и списком партнёров на сервере, но отсутствует проверка факта просмотра рекламы или подписки.【F:backend/src/services/userService.ts†L120-L207】【F:backend/src/services/userService.ts†L308-L356】

**Рекомендации.**
- Интегрировать сторонний ad-network/webhook для выдачи токена подтверждения просмотра.
- Для партнёров использовать оффчейн-проверки (бот/вебхук) перед начислением награды.

## Средний приоритет
- Конфигурация экономики теперь вынесена в `shared/config`, но бэкенд всё равно импортирует её напрямую. Стоит ограничить возможность менять конфиг на сервере и добавить версионирование при деплое.【F:shared/config/economy.ts†L1-L48】【F:backend/src/services/userService.ts†L30-L118】
- Отсутствует централизованный логинг: используется `console.info`/`console.error` в сервере. Рекомендуется подключить структурированные логи и алерты для продакшена.【F:backend/src/server.ts†L10-L24】

## Низкий приоритет
- Ошибки TON Connect по-прежнему обрабатываются на клиенте минимально; стоит расширить сообщения и UX в `WalletScreen` для реальных пользователей.【F:frontend/components/WalletScreen.tsx†L1-L460】
