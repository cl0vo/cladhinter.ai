# Аудит Cladhunter (MongoDB версия)

## Краткое резюме
- REST API теперь обслуживается промежуточным слоем Vite и напрямую обращается к MongoDB через Mongoose.【F:server/routes.ts†L1-L137】
- Авторизация по-прежнему завязана на клиентские данные (TON Connect) и не проверяется сервером, поэтому злоумышленник может подделывать `userId` и выполнять любые операции.【F:server/services/userService.ts†L64-L118】
- Большинство бизнес-проверок (лимиты рекламы, валидация оплат, партнёрские награды) реализованы поверх MongoDB без дополнительных подписи/вебхуков и полагаются на корректность клиентских вызовов.【F:server/services/userService.ts†L120-L356】

## Критические находки

### 1. Нет серверной аутентификации запросов
**Риск.** API опирается на `userId`, полученный из запроса. Любой может создать произвольный идентификатор и «майнить» энергию, активировать бусты или забирать партнёрские награды без ограничений.【F:server/routes.ts†L30-L123】【F:server/services/userService.ts†L120-L221】

**Рекомендации.**
- Внедрить подпись запросов (например, JWT, выданный сервером после проверки TON Connect).
- Вести историю сессий и блокировать подозрительные запросы (rate limiting + IP/UA анализ).

### 2. Подтверждение платежей не требует реальной транзакции
**Риск.** Эндпоинты `/api/orders/confirm` и `/api/orders/register-payment` сразу переводят заказ в статус `paid`/`pending_verification`, увеличивая уровень буста без проверки факта оплаты.【F:server/services/userService.ts†L188-L267】

**Рекомендации.**
- Добавить вебхук TON и подтверждать статус заказа только после проверки транзакции.
- Хранить и сверять сумму/кошелёк при подтверждении, запрещать повторное использование payload.

### 3. Клиент контролирует награды и просмотры
**Риск.** Фронтенд свободно вызывает `/api/ads/complete` и `/api/rewards/claim`. Валидация ограничивается лимитами по количеству и списком партнёров на сервере, но отсутствует проверка факта просмотра рекламы или подписки.【F:server/services/userService.ts†L120-L186】【F:server/services/userService.ts†L308-L356】

**Рекомендации.**
- Интегрировать сторонний ad-network/webhook для выдачи токена подтверждения просмотра.
- Для партнёров использовать оффчейн-проверки (бот/вебхук) перед начислением награды.

## Средний приоритет
- Конфигурация экономики дублируется между фронтендом и сервером (`config/economy.ts` и расчёты на стороне MongoDB). Стоит выделить единый источник правды и шарить его только в read-only виде.【F:server/services/userService.ts†L26-L118】【F:config/economy.ts†L1-L48】
- Отсутствует централизованный логинг: используется `console.info`/`console.error` в Vite. Рекомендуется подключить структурированные логи и алерты для продакшена.【F:vite.config.ts†L8-L31】

## Низкий приоритет
- Ошибки TON Connect по-прежнему обрабатываются на клиенте минимально; стоит расширить сообщения и UX в `WalletScreen` для реальных пользователей.【F:components/WalletScreen.tsx†L52-L239】
 
